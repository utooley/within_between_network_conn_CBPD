---
title: "CBPD Flux Analyses"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup}
library(dplyr)
library(stats)
library(parallel)
library(lm.beta)
subjdata_dir="~/Documents/projects/in_progress/within_between_network_conn_CBPD/data/subjectData/"
main <- read.csv(paste0(subjdata_dir, "cbpd_190321_fromallyson.csv"))
main <- read.csv("~/Box/Mackey_Lab/CBPD (825656)/Data/Redcap Data/CBPD_data_190620_forJulia.csv")

avgweight_dir="~/Desktop/cluster/jux/mackey_group/Ursula/projects/in_progress/within_between_network_conn_CBPD/data/imageData/gsr_censor_5contig_fd0.5dvars1.75_drpvls//"
withavgweight <- read.csv(paste0(avgweight_dir,"n64_within_between_Yeo_Schaefer400_gsr_censor_5contig_fd0.5dvars1.75_drpvls_with_QA.csv"))

#filter out extra variables in average weight
#withavgweight$cbpdid<- paste0("sub-",withavgweight$Var1)
withavgweight$record_id <- withavgweight$ID
main$ID <- paste0("sub-",main$record_id)
main <- merge(withavgweight,main, by="ID")

#make factor variables as factors
main$male <- factor(main$male, levels=c(0,1), labels=c("Female", "Male"))
#filter out some unneeded variables
main <- main %>% select(.,-c(cbcl_18mo_admin:cbcl_6yr_complete))
#main <- main %>% select(.,-c(has_diagnoses:letterword_identification_comple))
```


```{r Age and networks}
#filter on usable rest data
#main_rest <- filter(main,usable_rest==1)
#merge in average weight data
#main_rest$cbpdid <- paste0("sub-",main_rest$cbpdid)
#main_rest <- right_join(avgweight,main_rest, by="cbpdid")
#filter out only kids under 8
main_under9 <- filter(main, age_scan <=9)
main_rest=main
main_unique <- main %>% group_by(ID) %>% filter(row_number() == 1)

#look at mean within and between with age
l <- lm(mean_within_sys~age_scan+male+fd_mean+avgweight, data=main_unique)
summary(l)
lm.beta(l)
l <- lm(mean_between_sys~age_scan+male+fd_mean+avgweight, data=main_unique)
summary(l)
lm.beta(l)
l <- lm(system_segreg~age_scan+male+fd_mean+avgweight, data=main_unique)
summary(l)
#look at average weight with age
l <- lm(avgweight~age_scan+male+fd_mean, data=main_unique)
summary(l)
lm.beta(l)

networks <- select(main_rest, X1to1:X7to7)
nets <- colnames(networks)
#look at non-linear interaction between age and envSES 
for (net in nets){
  name<-paste0("lm_",net)
  formula<-formula(paste0(net, '~age_scan+male+fd_mean+avgweight'))
  assign(name, lm(formula, data=main_unique))
  #p_val[net] <- summary(name)$coefficients[2,4]
}
summary(lm_X1to1) #increase with age
summary(lm_X1to2)
summary(lm_X1to3) #increase with age
lm.beta(lm_X1to3)
summary(lm_X1to4)
summary(lm_X1to5)
summary(lm_X1to6)
summary(lm_X1to7)
summary(lm_X2to2)
summary(lm_X2to3)
summary(lm_X2to4)
summary(lm_X2to5)
summary(lm_X2to6)
summary(lm_X2to7)
summary(lm_X6to6)
summary(lm_X6to3)
summary(lm_X6to4)
summary(lm_X6to5)
summary(lm_X6to6)
summary(lm_X6to7)
summary(lm_X7to7)#increase with age
summary(lm_X7to3) #marginal decrease with age
lm.beta(lm_X7to3)
summary(lm_X7to4) #strong decrease with age
summary(lm_X7to5)
```

# Look at each column and correct for multiple comparisons
```{r}

covariates="~ age_scan+male+fd_mean+avgweight"

#make a dataframe with no repeats of net comparisons
main_rest <- select(main_rest, -c(X2to1,X3to1,X3to2,X4to1,X4to2,X4to3,X5to1,X5to2,X5to3,X5to4,X6to1,X6to2,X6to3,X6to4,X6to5,X7to1,X7to2,X7to3,X7to4,X7to5,X7to6))
#run and compare for multiple comparisons again
m <- mclapply(names(main_rest[,48:75]), function(x) {as.formula(paste(x, covariates, sep=""))},mc.cores=2)
networks_Age_pvals <- mclapply(m, function(x) { summary(lm(formula = x,data=main_rest))$coefficients[2,4]},mc.cores=1)
networks_Age_pvals <- as.data.frame(networks_Age_pvals)
networks_Age_pvals <- t(networks_Age_pvals)
networks_Age_pvals <- as.data.frame(networks_Age_pvals)
#bonferroni correct
networks_Age_pvals_fdr <- p.adjust(networks_Age_pvals$V1, method="fdr")
```

